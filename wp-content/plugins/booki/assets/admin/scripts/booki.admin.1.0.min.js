/*
 Copyright @ 2014 Alessandro Zifiglio. All rights reserved. http://www.booki.io
*/
(function(k,f){k.Booki=f||function(){}})(window,Booki);
(function(){Booki.OptionalsBookingMode={eachBooking:0,eachDay:1};Booki.OptionalsListingMode={checkboxList:0,radioButtonList:1};Booki.BookingWizardMode={tabs:0,linear:1};Booki.ElementType={textbox:0,textarea:1,dropdownlist:2,listbox:3,checkbox:4,radiobutton:5,h1:6,h2:7,h3:8,h4:9,h5:10,h6:11,plaintext:12,tc:13};Booki.DayName={monday:0,tuesday:1,wednesday:2,thursday:3,friday:4,saturday:5,sunday:6};Booki.Sidenav={detail:0,edit:1};Booki.CalendarMode={popup:0,inline:1,range:2,nextDayCheckout:3,event:4};
Booki.BookingMode={reservation:0,appointment:1};Booki.Period={byDay:0,byTime:1};Booki.ProjectStatus={stopped:0,running:1};Booki.Direction={up:0,down:1};Booki.HourFormat={H24:0,AMPM:1};Booki.ProjectStep={bookingForm:0,customFormFields:1,attendees:2}})();(function(){Number.prototype.pad=function(k){if(typeof k!=="number")k=2;for(var f=String(this);f.length<k;)f="0"+f;return f};Booki.rfc3986EncodeURIComponent=function(k){return encodeURIComponent(k).replace(/[!'()*]/g,escape)}})(window.jQuery);
(function(k,f,g,c){g.fn.outerHTML=function(){var i=g(this),j;if("outerHTML"in i[0])return i[0].outerHTML;else{j=i.wrap("<div></div>").parent().html();i.unwrap();return j}};var a=k.Booki,b,e,d,h;a.progressBarShow=function(i,j){if(!b){b=g("#progressModal").modal({backdrop:"static",show:false});e=b.find(".progress-bar");d=b.find(".progress-method");h=b.find(".progress-url")}if(i&&j){d.html(i);h.html(j)}b.modal("show").is(":visible");e.addClass("stretch")};a.progressBarHide=function(){if(b&&b.hasClass("in")){e.removeClass("stretch");
b.modal("hide").is(":visible")}};g(document).ajaxStop(function(){a.progressBarHide()});a.httpRequestParams=function(i,j,l){var n={type:"POST",dataType:"json"};i=j.action[i];if(!l.url){var m;m=(m=j)&&m.url?c.isFunction(m.url)?m.url():m.url:null;if(!m)throw Error('A "url" property or function must be specified');n.url=m}n.contentType="application/x-www-form-urlencoded";if(!l.preserveModels&&j.models&&j.models.length>0)j=j.models[0];n.data={model:a.rfc3986EncodeURIComponent(k.JSON.stringify(j.toJSON())),
action:i};return n};Backbone.sync=function(i,j,l){l||(l={});var n=a.httpRequestParams(i,j,l);a.progressBarHide();a.progressBarShow(j.action[i],j.url);return g.ajax(c.extend(n,l))};a.Admin=function(){};g(k).load(function(){var i=new a.ProjectsView({el:g("#projects-view")}),j,l,n,m;g('a[data-toggle="tab"]').click(function(p){var q=this.hash.slice(1),o=i.selectedId,r=g(this);p.preventDefault();if(typeof o!=="number"||o===-1)return false;g('.nav.nav-list a[href="#formelement"]').tab("show");r.tab("show");
switch(q){case "step2":case "formelements":if(j){j.undelegateEvents();j.collection.reset();j.dispose()}j=new a.FormElementsView({el:g("#formelements-view"),projectId:o});break;case "step3":if(l){l.undelegateEvents();l.dispose()}l=new a.CalendarView({el:g("#calendar-view"),projectId:o});break;case "step4":n&&n.undelegateEvents();n=new a.OptionalsView({el:g("#optionals-view"),projectId:o});break;case "step5":if(m){m.undelegateEvents();m.dispose()}m=new a.CascadingListView({el:g("#cascadinglist-view"),
projectId:o})}})})})(window,window.ajaxurl,window.jQuery,window._,window.JSON);(function(k,f,g){Booki.FilteredCollectionBase=Backbone.Collection.extend({initialize:function(c,a){this.id=a.id},sync:function(c,a,b){b||(b={});c=Booki.httpRequestParams(c,a,b);c.data.model=k.JSON.stringify({id:a.id});return g.ajax(_.extend(c,b))}})})(window,window.ajaxurl,window.jQuery);(function(){Booki.ModelBase=Backbone.Model.extend({})})(window,jQuery,_);
(function(k,f){Booki.ViewBase=Backbone.View.extend({validate:function(g){f(this.el).find(".booki_parsley_validated").each(function(){f(this).parsley(g)})},isValid:function(g){var c=true;g=g||".booki_parsley_validated";f(this.el).find(g).each(function(){var a=f(this);if(!a.is(":visible")||a.is(":disabled"))return true;a=f(this).parsley().validate(true);if(a!==null&&typeof a==="object"&&a.length>0)c=false});return c},parseDefault:function(g,c){if(typeof g==="undefined"||g===null)return typeof c==="undefined"?
"":c;return g},tooltip:function(){f("[data-toggle=tooltip]").tooltip()},sortIntAsc:function(g,c){return g-c}})})(window,jQuery,_);(function(k){Booki.Calendar=Booki.ModelBase.extend({url:k,action:{create:"booki_insertCalendar",update:"booki_updateCalendar","delete":"booki_deleteCalendar",read:"booki_readCalendarByProject"}})})(window.ajaxurl,window.moment);
(function(k){Booki.CalendarDay=Booki.ModelBase.extend({url:k,action:{create:"booki_insertCalendarDay",update:"booki_updateCalendarDay","delete":"booki_deleteCalendarDay",read:"booki_readCalendarDay"}})})(window.ajaxurl,window.moment);(function(k){Booki.CascadingItem=Booki.ModelBase.extend({url:k,action:{create:"booki_insertCascadingItem",update:"booki_updateCascadingItem","delete":"booki_deleteCascadingItem",read:"booki_readCascadingItem"}})})(window.ajaxurl);
(function(k){Booki.CascadingList=Booki.ModelBase.extend({url:k,action:{create:"booki_insertCascadingList",update:"booki_updateCascadingList","delete":"booki_deleteCascadingList",read:"booki_readCascadingList"}})})(window.ajaxurl);(function(k){Booki.CleanupCalendarDays=Booki.ModelBase.extend({url:k,action:{"delete":"booki_cleanupCalendarDay"}})})(window.ajaxurl);(function(k){Booki.DuplicateProject=Booki.ModelBase.extend({url:k,action:{create:"booki_duplicateProject"}})})(window.ajaxurl);
(function(k,f){Booki.FormElement=Booki.ModelBase.extend({url:k,action:{create:"booki_insertFormElement",update:"booki_updateFormElement","delete":"booki_deleteFormElement",read:"booki_readFormElement"},createElement:function(){var g=this.get("elementType"),c=this.get("bindingData"),a=this.get("value"),b=this.get("value"),e=this.get("label"),d="",h,i,j="form-control",l=arguments.length===0?this.get("className"):null,n;switch(g){case 0:d="input";h="text";break;case 1:d="textarea";break;case 2:d="select";
a=null;break;case 3:d="select";i="multiple";a=null;break;case 4:case 13:d="input";h="checkbox";j=a=null;break;case 5:d="input";h="radio";j=null;break;case 6:d="h1";j=null;break;case 7:d="h2";j=null;break;case 8:d="h3";j=null;break;case 9:d="h4";j=null;break;case 10:d="h5";j=null;break;case 11:d="h6";j=null;break;case 12:d="p";j=null}d=f(document.createElement(d));h&&d.attr("type",h);if(h==="checkbox"||h==="radio"){h==="radio"&&d.attr("value",e);c&&c[0]&&d.attr("checked",true)}else if(typeof a==="string"&&
a.length>0)g>=6&&g<=12?d.append(a):d.attr("value",a);i&&d.attr(i,i);if(c.length>0&&(g===2||g===3))for(n in c){g=c[n];d.append(f('<option value="'+n+'"'+(g===b?" selected":"")+">"+g+"</option>"))}j&&d.addClass(j);l&&d.addClass(l);return d.outerHTML()}})})(window.ajaxurl,window.jQuery);(function(k){Booki.NamelessDays=Booki.ModelBase.extend({url:k,action:{"delete":"booki_deleteNamelessDays"}})})(window.ajaxurl,window.moment);
(function(k){Booki.Optional=Booki.ModelBase.extend({url:k,action:{create:"booki_insertOptional",update:"booki_updateOptional","delete":"booki_deleteOptional",read:"booki_readOptional"}})})(window.ajaxurl);(function(k){Booki.Project=Booki.ModelBase.extend({url:k,action:{create:"booki_insertProject",update:"booki_updateProject","delete":"booki_deleteProject",read:"booki_readProject"}})})(window.ajaxurl,window.jQuery);
(function(k){Booki.QuantityElement=Booki.ModelBase.extend({url:k,action:{create:"booki_insertQuantityElement",update:"booki_updateQuantityElement","delete":"booki_deleteQuantityElement",read:"booki_readQuantityElement"}})})(window.ajaxurl);(function(k){Booki.QuantityElementItem=Booki.ModelBase.extend({url:k,action:{create:"booki_insertQuantityElementItem",update:"booki_updateQuantityElementItem","delete":"booki_deleteQuantityElementItem",read:"booki_readQuantityElementItem"}})})(window.ajaxurl);
(function(k){Booki.QuantityElementItemDelete=Booki.ModelBase.extend({url:k,action:{"delete":"booki_deleteQuantityElementItems"}})})(window.ajaxurl);(function(k){Booki.TimeSlots=Booki.ModelBase.extend({url:k,action:{read:"booki_createTimeSlots"}})})(window.ajaxurl);
(function(k){Booki.CalendarDays=Backbone.Collection.extend({model:Booki.CalendarDay,url:k,action:{read:"booki_readAllCalendarDays",create:"booki_insertCalendarDays",update:"booki_updateCalendarDays","delete":"booki_deleteCalendarDays"},create:function(f){f=f||{};f.preserveModels=true;return Backbone.sync("create",this,f)},save:function(f){f=f||{};f.preserveModels=true;return Backbone.sync("update",this,f)},"delete":function(f){return Backbone.sync("delete",this,f)}})})(window.ajaxurl);
(function(k){Booki.CascadingItems=Backbone.Collection.extend({model:Booki.CascadingItem,url:k,action:{read:"booki_readAllCascadingItem"}})})(window.ajaxurl);(function(k){Booki.CascadingLists=Backbone.Collection.extend({model:Booki.CascadingList,url:k,action:{read:"booki_readAllCascadingList"}})})(window.ajaxurl);(function(k){Booki.FormElements=Backbone.Collection.extend({model:Booki.FormElement,url:k,action:{read:"booki_readAllFormElement"},comparator:function(f){return f.get("rowIndex")}})})(window.ajaxurl);
(function(k){Booki.Optionals=Backbone.Collection.extend({model:Booki.Optional,url:k,action:{read:"booki_readAllOptional"}})})(window.ajaxurl);(function(k){Booki.Projects=Backbone.Collection.extend({model:Booki.Project,url:k,action:{read:"booki_readAllProject"}})})(window.ajaxurl,window.jQuery);(function(k){Booki.QuantityElementsByCalendar=Backbone.Collection.extend({model:Booki.QuantityElement,url:k,action:{read:"booki_readAllQuantityElementsByCalendarId"}})})(window.ajaxurl);
(function(k){Booki.QuantityElementsByCalendarDay=Backbone.Collection.extend({model:Booki.QuantityElement,url:k,action:{read:"booki_readAllQuantityElementsByCalendarDayIdList"}})})(window.ajaxurl);(function(k){Booki.Seasons=Backbone.Collection.extend({url:k,action:{read:"booki_readAllSeasons"}})})(window.ajaxurl);(function(k){Booki.Tags=Backbone.Collection.extend({url:k,action:{read:"booki_readAllProjectTags"}})})(window.ajaxurl);
(function(k,f,g,c){Booki.CalendarDayView=Booki.ViewBase.extend({events:{"click .create.btn":"create","click .update.btn":"save","click .delete.btn":"delete","click .new-quantity-element.btn":"newQuantityElement","click .update-quantity-element.btn":"updateQuantityElement","click .delete-quantity-element.btn":"deleteQuantityElement","click .update-quantity-element-item.btn":"updateQuantityElementItem","click .delete.btn.delete-nameless-days":"deleteNamelessDays",'change input:not([type="checkbox"].calendardayweek)':"inputChanged",
'change select:not([multiple="multiple"])':"inputChanged",'change select[name="quantityElementDisplayMode"]':"inputChanged",'change select[name="quantityElementBookingMode"]':"inputChanged",'change select[name="quantityElements"]':"quantityElementsChanged",'change select[name="seatMode"]':"inputChanged",'change [type="checkbox"].calendardayweek':"weekDayChanged","click .remove-time.btn":"removeSelectedTime","click .reset-time.btn":"resetExcludedTime","change select.time-list":"timeListChanged"},initialize:function(a){var b=
f("#calendar-day-template");this.calendarId=a.calendarId;this.projectId=a.projectId;this.minDate=a.minDate;this.maxDate=a.maxDate;this.selectedEndDate=this.minDate;this.selectedStartDate=this.maxDate;this.weekDaysExcluded=a.weekDaysExcluded;this.daysExcluded=a.daysExcluded;this.hours=a.hours;this.minutes=a.minutes;this.timeSlots=a.timeSlots;this.period=a.period;this.cost=a.cost;this.enableSingleHourMinuteFormat=a.enableSingleHourMinuteFormat;this.selectedSeason="0";this.dateFormat="MM/DD/YYYY";this.datePickerDateFormat=
"mm/dd/yy";this.currencySymbol=Booki.localization.currencySymbol;this.thousandsSep=Booki.localization.thousandsSep;this.decimalPoint=Booki.localization.decimalPoint;this.hourFormat=Booki.HourFormat.H24;this.weekdays=[];this.quantityElement=this.getDefaultQuantityModel();this.quantityElements=new Booki.QuantityElementsByCalendarDay;this.quantityValidationGroup=".booki_parsley_validated_quantity";_.bindAll(this,"render");if(b.length>0)this.template=_.template(b.html());this.cleanupCalendarDays=new Booki.CleanupCalendarDays({id:this.calendarId});
this.render()},render:function(a){var b=this,e=this.calendarId,d=this.model;if(a){if(a.startDate){this.minDate=a.startDate;d&&typeof d.get("id")!=="number"&&d.set({day:this.minDate},{silent:true})}if(a.endDate)this.maxDate=a.endDate;if(a.weekDaysExcluded)this.weekDaysExcluded=a.weekDaysExcluded;if(a.daysExcluded)this.daysExcluded=a.daysExcluded;if(a.timeslots)this.timeSlots=a.timeSlots;if(a.hours)this.hours=a.hours;if(a.minutes)this.hours=a.minutes;if(a.cost)this.hours=a.cost;if(typeof a.period===
"number")this.period=a.period}(new Booki.Seasons({calendarId:e})).fetch({success:function(h,i){b.seasons=new Backbone.Collection(i.seasons);b.calendarDays=new Backbone.Collection(i.calendarDays);b.collection=new Booki.CalendarDays({calendarId:e,seasonName:b.selectedSeason==="0"?null:b.selectedSeason});b.collection.fetch({success:function(j){if(j.length>0)b.model=j.at(0);else{b.selectedStartDate=b.getUnusedMinDate();b.selectedEndDate=b.selectedStartDate;b.model=b.getDefaultModel();b.collection.add(b.model)}b.quantityElement=
b.getDefaultQuantityModel();b.quantityElements=new Booki.QuantityElementsByCalendarDay({calendarDayIdList:b.getCalendarDaysIdList()});b.quantityElements.fetch({success:function(l){if(l.length>0)b.quantityElement=l.at(0);b.renderCalendarDay();b.validate()}})}})}})},renderCalendarDay:function(){var a,b;b=[];var e=[],d=0,h,i=this.collection,j=this.calendarDays.find(function(l){return!l.get("seasonName")&&!l.isNew()});if(this.el){h=this.model;for(a=f(this.el);d<24;){b.push(d.pad());++d}for(d=0;d<=60;){e.push(d.pad());
++d}b=this.template({hours:b,minutes:e,context:this,isNew:h.isNew(),model:h.toJSON(),models:i.toJSON(),hasChanges:h.hasChanged(),disableStatusTimeResetButton:h.get("timeExcluded").length===0?'disabled="disabled"':"",disableStatusDeleteButton:h.isNew()?'disabled="disabled"':"",localization:Booki.localization,accounting:c,disableStatusDaysResetButton:i.length>0,selectedSeason:this.selectedSeason,seasons:this.seasons.toJSON(),hasUnnamedSeasons:j?true:false,quantityElement:this.quantityElement.toJSON(),
quantityElementIsNew:this.quantityElement.isNew(),quantityElements:this.quantityElements});a.html(b);this.$quantitySection=a.find("#quantitycalendarydaysection");this.createDatePickers();this.tooltip()}},weekDayAvailable:function(a){var b=false;this.collection.each(function(e){e=e.get("day");if(a===g(e).weekday()){b=true;return false}});return b},weekDaysCount:function(a){var b,e,d,h=0;if(this.selectedStartDate&&this.selectedEndDate){b=g(this.selectedStartDate);for(e=g(this.selectedEndDate);b.isBefore(e)||
b.isSame(e);b.add("days",1))if(b.weekday()===a)(d=this.dateAvailable(b._d))&&++h}return h},weekDayChanged:function(a){a=f(a.target);a=parseInt(a.attr("name"),10);var b=f(this.el);b.find('[type="checkbox"].weekday:checked').map(function(){return parseInt(this.name,10)}).get();b.find('[type="checkbox"].weekday:disabled');if(this.weekdays.indexOf(a)===-1)this.weekdays.push(a);else this.weekdays=_.without(this.weekdays,a);this.resetCollection();this.renderCalendarDay()},formatDate:function(a){return g(a).format(this.dateFormat)},
createDatePickers:function(){var a=this,b=f(this.el),e=this.datePickerDateFormat,d=this.minDate,h=this.maxDate;e={defaultDate:new Date(this.model.get("day")),dateFormat:e,changeMonth:true,changeYear:true,minDate:new Date(d),maxDate:new Date(h),beforeShowDay:function(i){a.formatDate(i);i.getDay();if(!a.dateAvailable(i))return[false];return[true,"",""]}};this.$startDate=b.find("#cdstartdate");this.$endDate=b.find("#cdenddate");this.$startDate.datepicker(e);this.$endDate.datepicker(e);this.$startDate.datepicker("setDate",
this.selectedStartDate);this.$endDate.datepicker("setDate",this.selectedEndDate)},"delete":function(){var a=this;this.collection["delete"]({success:function(){a.selectedSeason="0";a.render()}})},deleteNamelessDays:function(){var a=this;(new Booki.NamelessDays(this.calendarId)).destroy({success:function(){a.model=null;a.render()}})},create:function(){var a=this,b;this.isValid()&&this.collection.create({success:function(e){a.collection.reset(e);a.model=a.collection.at(0);a.selectedSeason=a.model.get("seasonName");
b=new Booki.Seasons({calendarId:a.calendarId});b.fetch({success:function(d,h){a.seasons=new Backbone.Collection(h.seasons);a.calendarDays=new Backbone.Collection(h.calendarDays);a.renderCalendarDay();a.validate()}})}})},save:function(){var a=this;this.isValid()&&this.collection.save({success:function(){a.selectedSeason=a.model.get("seasonName");a.render()}})},inputChanged:function(a){var b=a.currentTarget;a=f(b);b=b.name;var e=a.hasClass("quantity-element"),d,h={},i=this.model,j;switch(b){case "selectedSeason":this.selectedSeason=
a.find("option:selected").val();this.render();return;case "seasonName":d=a.val();break;case "day":d=a.val();break;case "hours":case "minutes":d=parseInt(a.val(),10);if(d===0)if(b==="minutes"&&i.get("hours")===0||b==="hours"&&i.get("minutes")===0)d=1;j=true;break;case "hourStartInterval":case "minuteStartInterval":d=parseInt(a.val(),10);j=true;break;case "cost":d=a.val();break;case "cdstartdate":case "cdenddate":this.resetCollection();this.selectedStartDate=this.$startDate.val();this.selectedEndDate=
this.$endDate.val();this.weekdays=[];this.renderCalendarDay();return;case "minNumDaysDeposit":d=parseInt(a.val(),10);break;case "deposit":d=a.val();break;case "seatMode":parseInt(a.val(),10);case "bookingLimit":d=parseInt(a.val(),10);break;case "quantityElementName":d=a.val();b="name";break;case "quantityElementQuantity":d=parseInt(a.val(),10);b="quantity";break;case "quantityElementCost":d=parseFloat(a.val());b="cost";break;case "quantityElementDisplayMode":d=parseInt(a.val(),10);b="displayMode";
break;case "quantityElementBookingMode":d=parseInt(a.val(),10);b="bookingMode";break;case "quantityElementIsRequired":d=a.is(":checked");b="isRequired"}if(e)i=this.quantityElement;h[b]=d;i.set(h,{silent:true});this.update();j&&this.fetchTimeSlots()},fetchTimeSlots:function(){var a=this;(new Booki.TimeSlots({hours:this.model.get("hours"),minutes:this.model.get("minutes"),hourStartInterval:this.model.get("hourStartInterval"),minuteStartInterval:this.model.get("minuteStartInterval"),enableSingleHourMinuteFormat:this.enableSingleHourMinuteFormat})).fetch({success:function(b,
e){a.model.set({timeSlots:e.result},{silent:true});a.renderCalendarDay()}})},timeListChanged:function(a){a=a.srcElement||a.target;var b=f(this.el).find(".remove-time.btn");f(a).find("option").length>1?b.removeAttr("disabled"):b.attr("disabled","disabled")},removeSelectedTime:function(){var a=f(this.el),b=a.find(".remove-time.btn");a=a.find(".reset-time.btn");var e=this.model,d=e.get("timeExcluded");f('select[name="timelist"] option:selected').each(function(h,i){var j=f(i).val();d.indexOf(j)===-1&&
d.push(j);f(this).remove()});e.set({timeExcluded:d},{silent:true});b.attr("disabled",true);d.length===0?a.attr("disabled"):a.removeAttr("disabled")},resetExcludedTime:function(){f(this.el).find(".reset-time.btn").attr("disabled",true);this.model.set({timeExcluded:[]},{silent:true});this.renderCalendarDay()},getUnusedMinDate:function(){for(var a=this.minDate,b=g(this.minDate),e=g(this.maxDate),d;b.isBefore(e)||b.isSame(e);b.add("days",1))if(d=this.dateAvailable(b._d)){a=b.format(this.dateFormat);break}return a},
resetCollection:function(){var a,b,e,d=f(this.el).find('[type="checkbox"].calendardayweek:checked').map(function(){return parseInt(this.name,10)}).get();if(this.$startDate&&this.$endDate){this.collection.reset();a=g(this.$startDate.val());for(b=g(this.$endDate.val());a.isBefore(b)||a.isSame(b);a.add("days",1))if((e=this.dateAvailable(a._d))&&d.indexOf(a.weekday())===-1){e=this.getDefaultModel(this.model,a.format(this.dateFormat));this.collection.add(e)}this.collection.comparator=function(h){return h.get("day")};
this.collection.sort()}},dateAvailable:function(a){var b=this,e=true,d=a.getDay(),h=b.formatDate(a);f(this.daysExcluded).each(function(i,j){if(b.formatDate(j)===h)return e=false});if(!e)return e;this.calendarDays.each(function(i){if(b.formatDate(i.get("day"))==h)return e=false});if(!e)return e;f(this.weekDaysExcluded).each(function(i,j){if(d===j)return e=false});return e},update:function(){var a=this;this.collection.each(function(b){var e=a.model.clone();e.set({id:b.get("id"),day:b.get("day")},{silent:true});
b.set(e.attributes,{silent:true})})},getAllSeasons:function(a){var b=[],e;a.each(function(d){(e=d.get("seasonName"))&&b.indexOf(e)===-1&&b.push(e)});return b},quantityElementsChanged:function(a){a=f(a.currentTarget);this.quantityElement=this.quantityElements.at(parseInt(a.val(),10));this.renderCalendarDay();this.expandQuantitySection()},newQuantityElement:function(){this.quantityElement=this.getDefaultQuantityModel();this.renderCalendarDay();this.expandQuantitySection()},updateQuantityElement:function(){var a=
this,b=this.quantityElement.previous("quantity"),e=this.quantityElement.get("quantity");if(this.isValid(this.quantityValidationGroup)){this.quantityElement.isNew()&&this.quantityElements.push(this.quantityElement);if(b!=e){b=new Booki.QuantityElementItemDelete({id:this.quantityElement.get("id")});b.destroy({success:function(){a.quantityElement.set({quantityElementItems:[]});a.saveQuantityElement()}})}else this.saveQuantityElement()}},saveQuantityElement:function(){var a=this;this.quantityElement.set({calendarId:null,
calendarDayIdList:this.getCalendarDaysIdList()});this.quantityElement.save(this.quantityElement.attributes,{success:function(){a.renderCalendarDay();a.expandQuantitySection()}})},deleteQuantityElement:function(){var a=this;this.quantityElement.destroy({success:function(){a.quantityElements.remove(a.quantityElement);a.quantityElement=a.getDefaultQuantityModel();a.renderCalendarDay();a.expandQuantitySection()}})},updateQuantityElementItem:function(a){a=f(a.currentTarget);var b=this.getQuantityElementItem(parseInt(a.attr("data-booki-index"),
10)),e=this;(new Booki.QuantityElementItem(b)).save(b.attributes,{success:function(d){b.id=d.get("id");e.renderCalendarDay();e.expandQuantitySection()}})},getQuantityElementItem:function(a){var b=f(this.el).find('input[data-booki-index="'+a+'"]'),e=parseFloat(b.val()),d=this.quantityElement.get("id");b=this.quantityElement.get("quantityElementItems");var h,i,j;for(j=0;j<b.length;j++){h=b[j];if(h.quantityIndex===a){h.cost=e;h.elementId=d;i=true;break}}if(!i){a={elementId:d,quantityIndex:a,cost:e};
h=new Booki.QuantityElementItem(a);b.push(a)}return h},expandQuantitySection:function(){this.$quantitySection.collapse("show")},getCalendarDaysIdList:function(){var a=[];this.collection.each(function(b){a.push(b.get("id"))});return a},getDefaultQuantityModel:function(){return new Booki.QuantityElement({calendarId:null,projectId:this.projectId,calendarDayIdList:[],quantity:0,cost:0,name:"",quantityElementItems:[],displayMode:0,bookingMode:1,isRequired:false})},getDefaultModel:function(a,b){var e=a?
a.get("seasonName"):"",d=a?a.get("timeExcluded"):[],h=a?a.get("daysExcluded"):this.daysExcluded,i=a?a.get("weekDaysExcluded"):this.weekDaysExcluded,j=a?a.get("hours"):this.hours,l=a?a.get("minutes"):this.minutes,n=a?a.get("cost"):this.cost,m=a?a.get("timeSlots"):this.timeSlots,p=a?a.get("hourStartInterval"):0,q=a?a.get("minuteStartInterval"):0,o=a?a.get("minNumDaysDeposit"):0,r=a?a.get("deposit"):0,s=a?a.get("seatMode"):1,t=a?a.get("bookingLimit"):0;b=b||this.selectedStartDate;return new Booki.CalendarDay({id:null,
calendarId:this.calendarId,day:this.formatDate(b),seasonName:e,timeExcluded:d,daysExcluded:h,weekDaysExcluded:i,hours:j,minutes:l,cost:n,timeSlots:m,hourStartInterval:p,minuteStartInterval:q,minNumDaysDeposit:o,deposit:r,seatMode:s,bookingLimit:t})}})})(window.ajaxurl,window.jQuery,window.moment,window.accounting);
(function(k,f,g,c){Booki.CalendarView=Booki.ViewBase.extend({events:{"click .update.btn":"save","click .new-quantity-element.btn":"newQuantityElement","click .update-quantity-element.btn":"updateQuantityElement","click .delete-quantity-element.btn":"deleteQuantityElement","click .update-quantity-element-item.btn":"updateQuantityElementItem","click .cancel.btn":"discardChanges","change input":"inputChanged",'change select[name="hours"]':"inputChanged",'change select[name="minutes"]':"inputChanged",
'change select[name="hourStartInterval"]':"inputChanged",'change select[name="minuteStartInterval"]':"inputChanged",'change select[name="quantityElementMode"]':"inputChanged",'change select[name="quantityElementDisplayMode"]':"inputChanged",'change select[name="quantityElementBookingMode"]':"inputChanged",'change select[name="bookingStartLapseMode"]':"inputChanged",'change select[name="reminderMode"]':"inputChanged",'change select[name="seatMode"]':"inputChanged",'change select[name="quantityElements"]':"quantityElementsChanged",
"click .remove-day.btn":"removeSelectedDays","click .remove-time.btn":"removeSelectedTime","click .reset-day.btn":"resetExcludedDays","click .reset-time.btn":"resetExcludedTime","change select.days-list":"daysListChanged","change select.time-list":"timeListChanged"},initialize:function(a){var b=f("#calendar-template");this.projectId=a.projectId;this.dateFormat="MM/DD/YYYY";this.datePickerDateFormat="mm/dd/yy";this.hourFormat=Booki.HourFormat.H24;this.quantityElement=this.getDefaultQuantityModel();
this.quantityElements=new Booki.QuantityElementsByCalendar;this.quantityValidationGroup=".booki_parsley_validated_quantity";if(!this.model)this.model=this.getDefaultModel();_.bindAll(this,"render");if(b.length>0)this.template=_.template(b.html());this.thousandsSep=Booki.localization.thousandsSep;this.decimalPoint=Booki.localization.decimalPoint;this.render()},render:function(){var a=this;this.model.fetch({success:function(b){if(typeof b.get("id")==="number"){a.model.set(b.attributes);a.quantityElement=
a.getDefaultQuantityModel();a.quantityElements=new Booki.QuantityElementsByCalendar({calendarId:b.get("id")});a.quantityElements.fetch({success:function(e){if(e.length>0)a.quantityElement=e.at(0);a.renderCalendar(true)}})}else a.renderCalendar(true)}})},renderCalendar:function(a){var b,e;e=[];var d=[],h=0,i=this.model,j=new Date(this.formatDate(i.get("startDate"))),l=new Date(this.formatDate(i.get("endDate"))),n=!(i.hasChanged("affectedRecords")||i.hasChanged("id"))&&i.hasChanged(),m=i.isNew()||n;
if(this.el){for(b=f(this.el);h<24;){e.push(h.pad());++h}for(h=0;h<=60;){d.push(h.pad());++h}e=this.template({days:this.getDays(j,l),hours:e,minutes:d,context:this,isNew:i.isNew(),model:i.toJSON(),hasChanges:n,disableStatusDaysResetButton:i.get("daysExcluded").length>0||i.get("weekDaysExcluded").length>0?"":'disabled="disabled"',disableStatusTimeResetButton:i.get("timeExcluded").length===0?'disabled="disabled"':"",localization:Booki.localization,accounting:c,quantityElement:this.quantityElement.toJSON(),
quantityElementIsNew:this.quantityElement.isNew(),quantityElements:this.quantityElements});b.html(e);this.$quantitySection=b.find("#quantitycalendarsection");this.createDatePickers();this.createSidenavView();m||this.createModelView(a);this.sidenavView.showTab(0);this.sidenavView.disableTab(1,m);this.validate();this.tooltip()}},createSidenavView:function(){if(!this.sidenavView)this.sidenavView=new Booki.SidenavView({template:f("#calendar-sidenav-template"),tab:".calendar-tab",el:f("#calendar-sidenav-view")})},
createModelView:function(a){var b=this.formatDate(this.model.get("startDate")),e=this.formatDate(this.model.get("endDate")),d=this.model.get("weekDaysExcluded"),h=this.model.get("daysExcluded"),i=this.model.attributes;if(this.modelView)a&&this.modelView.render(i);else this.modelView=new Booki.CalendarDayView({calendarId:this.model.get("id"),projectId:this.projectId,el:f("#calendar-day-view"),minDate:b,maxDate:e,weekDaysExcluded:d,daysExcluded:h,period:this.model.get("period"),cost:this.model.get("cost"),
hours:this.model.get("hours"),minutes:this.model.get("minutes"),timeSlots:this.model.get("timeSlots"),enableSingleHourMinuteFormat:this.model.get("enableSingleHourMinuteFormat")})},formatDate:function(a){return g(a).format(this.dateFormat)},createDatePickers:function(){var a=this.model,b=this.datePickerDateFormat,e=this,d=f("#startdate"),h=f("#enddate");d.datepicker({defaultDate:new Date(a.get("startDate")),dateFormat:b,changeMonth:true,changeYear:true,onSelect:function(i){a.set({startDate:i},{silent:true});
e.renderCalendar();h.datepicker("option","minDate",i)}});h.datepicker({defaultDate:new Date(a.get("endDate")),dateFormat:b,changeMonth:true,changeYear:true,numberOfMonths:3,minDate:new Date(a.get("startDate")),onSelect:function(i){a.set({endDate:i},{silent:true});e.renderCalendar();d.datepicker("option","minDate",i)}})},daysListChanged:function(){f(this.el).find(".remove-day.btn").removeAttr("disabled")},timeListChanged:function(a){a=a.srcElement||a.target;var b=f(this.el).find(".remove-time.btn");
f(a).find("option").length>1?b.removeAttr("disabled"):b.attr("disabled","disabled")},save:function(){var a=this.model,b=this;this.isValid()&&a.save(a.attributes,{success:function(){b.renderCalendar()}})},discardChanges:function(){this.render()},inputChanged:function(a){var b=a.currentTarget;a=f(b);var e=a.hasClass("quantity-element");b=b.name;var d,h={},i=this.model,j,l;switch(b){case "weekday":d=f('[type="checkbox"].weekday:checked').map(function(){return parseInt(this.value,10)}).get();b="weekDaysExcluded";
l=true;break;case "hours":case "minutes":d=parseInt(a.val(),10);if(d===0)if(b==="minutes"&&this.model.get("hours")===0||b==="hours"&&this.model.get("minutes")===0)d=1;j=true;break;case "hourStartInterval":case "minuteStartInterval":d=parseInt(a.val(),10);j=true;break;case "cost":d=a.val();break;case "period":d=parseInt(a.val(),10);if(d===Booki.Period.byDay&&i.get("timeSlots").length>1)h={hours:23,minutes:60,timeSlots:[]};l=true;break;case "seatMode":d=parseInt(a.val(),10);case "bookingLimit":d=parseInt(a.val(),
10);break;case "displayCounter":d=a.is(":checked");break;case "minNumDaysDeposit":d=parseInt(a.val(),10);break;case "deposit":d=a.val();break;case "quantityElementMode":d=parseInt(a.val(),10);break;case "availabilityByQuantityElement":d=a.is(":checked");break;case "includePriceInQuantityElement":d=a.is(":checked");break;case "bookingStartLapse":d=parseInt(a.val(),10);break;case "bookingStartLapseMode":d=parseInt(a.val(),10);break;case "reminder":d=parseInt(a.val(),10);break;case "reminderMode":d=
parseInt(a.val(),10);break;case "enableSingleHourMinuteFormat":d=a.is(":checked");j=true;break;case "quantityElementName":d=a.val();b="name";break;case "quantityElementQuantity":d=parseInt(a.val(),10);b="quantity";break;case "quantityElementCost":d=parseFloat(a.val());b="cost";break;case "quantityElementDisplayMode":d=parseInt(a.val(),10);b="displayMode";break;case "quantityElementBookingMode":d=parseInt(a.val(),10);b="bookingMode";break;case "quantityElementIsRequired":d=a.is(":checked");b="isRequired"}if(e)i=
this.quantityElement;h[b]=d;i.set(h,{silent:true});if(j)this.fetchTimeSlots();else l&&this.renderCalendar(true)},fetchTimeSlots:function(){var a=this;(new Booki.TimeSlots({hours:this.model.get("hours"),minutes:this.model.get("minutes"),hourStartInterval:this.model.get("hourStartInterval"),minuteStartInterval:this.model.get("minuteStartInterval"),enableSingleHourMinuteFormat:this.model.get("enableSingleHourMinuteFormat")})).fetch({success:function(b,e){a.model.set({timeSlots:e.result},{silent:true});
a.renderCalendar(true)}})},removeSelectedDays:function(){var a=f(this.el),b=a.find(".remove-day.btn");a=a.find(".reset-day.btn");var e=this.model,d=e.get("daysExcluded");f('select[name="dayslist"] option:selected').each(function(h,i){var j=f(i).val();d.indexOf(j)===-1&&d.push(j);f(this).remove()});e.set({daysExcluded:d},{silent:true});b.attr("disabled",true);d.length===0?a.attr("disabled"):a.removeAttr("disabled")},removeSelectedTime:function(){var a=f(this.el),b=a.find(".remove-time.btn");a=a.find(".reset-time.btn");
var e=this.model,d=e.get("timeExcluded");f('select[name="timelist"] option:selected').each(function(h,i){var j=f(i).val();d.indexOf(j)===-1&&d.push(j);f(this).remove()});e.set({timeExcluded:d},{silent:true});b.attr("disabled",true);d.length===0?a.attr("disabled"):a.removeAttr("disabled")},resetExcludedDays:function(){f(this.el).find(".reset-day.btn").attr("disabled",true);this.model.set({daysExcluded:[],weekDaysExcluded:[]},{silent:true});this.renderCalendar(true)},resetExcludedTime:function(){f(this.el).find(".reset-time.btn").attr("disabled",
true);this.model.set({timeExcluded:[]},{silent:true});this.renderCalendar(true)},getDays:function(a,b){for(var e,d=[];a<=b;){d.push(this.formatDate(a));e=a.setDate(a.getDate()+1);a=new Date(e)}d=this.filterDaysExcluded(this.model.get("daysExcluded"),d,function(h,i){return h===i});return this.filterDaysExcluded(this.model.get("weekDaysExcluded"),d,function(h,i){return parseInt(h,10)===(new Date(i)).getDay()})},filterDaysExcluded:function(a,b,e){return b=f.grep(b,function(d){var h=true,i,j;for(i in a)if(j=
e(a[i],d)){h=false;break}return h})},quantityElementsChanged:function(a){a=f(a.currentTarget);this.quantityElement=this.quantityElements.at(parseInt(a.val(),10));this.renderCalendar();this.expandQuantitySection()},newQuantityElement:function(){this.quantityElement=this.getDefaultQuantityModel();this.renderCalendar();this.expandQuantitySection()},updateQuantityElement:function(){var a=this,b=this.quantityElement.previous("quantity"),e=this.quantityElement.get("quantity");if(this.isValid(this.quantityValidationGroup)){this.quantityElement.set({calendarId:this.model.get("id")});
this.quantityElement.isNew()&&this.quantityElements.push(this.quantityElement);if(b!=e){b=new Booki.QuantityElementItemDelete({id:this.quantityElement.get("id")});b.destroy({success:function(){a.quantityElement.set({quantityElementItems:[]});a.saveQuantityElement()}})}else this.saveQuantityElement()}},saveQuantityElement:function(){var a=this;this.quantityElement.save(this.quantityElement.attributes,{success:function(){a.renderCalendar();a.expandQuantitySection()}})},deleteQuantityElement:function(){var a=
this;this.quantityElement.destroy({success:function(){a.quantityElements.remove(a.quantityElement);a.quantityElement=a.getDefaultQuantityModel();a.renderCalendar();a.expandQuantitySection()}})},updateQuantityElementItem:function(a){a=f(a.currentTarget);var b=this.getQuantityElementItem(parseInt(a.attr("data-booki-index"),10)),e=this;(new Booki.QuantityElementItem(b)).save(b.attributes,{success:function(d){b.id=d.get("id");e.renderCalendar();e.expandQuantitySection()}})},getQuantityElementItem:function(a){var b=
f(this.el).find('input[data-booki-index="'+a+'"]'),e=parseFloat(b.val()),d=this.quantityElement.get("id");b=this.quantityElement.get("quantityElementItems");var h,i,j;for(j=0;j<b.length;j++){h=b[j];if(h.quantityIndex===a){h.cost=e;h.elementId=d;i=true;break}}if(!i){a={elementId:d,quantityIndex:a,cost:e};h=new Booki.QuantityElementItem(a);b.push(a)}return h},expandQuantitySection:function(){this.$quantitySection.collapse("show")},getDefaultQuantityModel:function(){var a=this.model?this.model.get("id"):
null;return new Booki.QuantityElement({calendarId:typeof a==="number"?a:null,projectId:this.projectId,quantity:0,cost:0,name:"",quantityElementItems:[],displayMode:0,bookingMode:0,isRequired:false})},getDefaultModel:function(){var a=this.formatDate(g());return new Booki.Calendar({id:null,projectId:this.projectId,startDate:a,endDate:a,daysExcluded:[],timeExcluded:[],weekDaysExcluded:[],hours:23,minutes:60,cost:0,timeSlots:[],period:Booki.Period.byDay,discount:0,bookingMinimumDiscount:0,hourStartInterval:0,
minuteStartInterval:0,seatMode:0,bookingLimit:0,displayCounter:false,bookedDaysCount:0,minNumDaysDeposit:0,deposit:0,bookingStartLapse:0,bookingStartLapseMode:0,reminder:0,reminderMode:0,enableSingleHourMinuteFormat:false,quantityElementMode:0,quantityElements:[],availabilityByQuantityElement:0,includePriceInQuantityElement:0})},dispose:function(){if(this.sidenavView){this.sidenavView.undelegateEvents();this.sidenavView.dispose()}this.modelView&&this.modelView.undelegateEvents()}})})(window.ajaxurl,
window.jQuery,window.moment,window.accounting);
(function(k,f,g,c){Booki.CascadingItemView=Booki.ViewBase.extend({events:{"click .update.btn":"save","click .new.btn":"new","click .add.btn":"add","click .remove.btn":"delete",'change input, select[name="parentId"]':"inputChanged",'change select[name="cascadingItems"]':"listboxChanged"},initialize:function(a){var b=f("#cascadingitem-template");this.cascadingList=a.cascadingList;this.cascadingLists=a.cascadingLists;this.selectedCascadingItemId=null;_.bindAll(this,"render");if(b.length>0)this.template=
_.template(b.html());this.currencySymbol=Booki.localization.currencySymbol;this.thousandsSep=Booki.localization.thousandsSep;this.decimalPoint=Booki.localization.decimalPoint;this.render()},render:function(){var a=this,b,e,d;(new Booki.CascadingItems(this.cascadingList)).fetch({success:function(h){(b=h.at(0))||(b=a.getDefaultModel());d=b.get("cascadingItems");e=new Booki.CascadingItems(d);if(a.selectedCascadingItemId!==null)b=e.find(function(i){return i.get("id")===a.selectedCascadingItemId});else if(!b.isNew()||
b.get("id")===null)b=a.getDefaultModel();e.length===0&&e.add(b);a.renderItems(b,e)}})},renderItems:function(a,b){var e,d;this.selectedCascadingItemId=null;this.model=a;this.models=b||new Booki.CascadingItems;if(this.el){e=f(this.el);d=this.template({context:this,isNew:a.isNew(),model:a.toJSON(),models:b.toJSON(),cascadingLists:this.cascadingLists.toJSON(),localization:Booki.localization,accounting:c});e.html(d);this.validate();this.tooltip()}},listboxChanged:function(a){var b=parseInt(f("option:selected",
a.srcElement||a.target).val(),10);this.renderItems(this.models.find(function(e){return e.get("id")===b}),this.models)},"new":function(){this.renderItems(this.getDefaultModel(),this.models)},add:function(){var a=this,b=this.model.get("id");this.models.find(function(e){return e.get("id")===b})||this.models.add(this.model);if(this.isValid()){this.selectedCascadingItemId=this.model.get("id");this.model.save(this.model.attributes,{success:function(){a.render()}})}},"delete":function(){var a=this;this.model.destroy({success:function(){a.render()}})},
save:function(){var a=this.model,b=this;if(this.isValid()){this.selectedCascadingItemId=this.model.get("id");a.save(a.attributes,{success:function(){b.render()}})}},inputChanged:function(a){var b=a.srcElement||a.target;a=f(b);b=b.name;var e,d={};switch(b){case "value":e=a.val();break;case "cost":e=a.val();break;case "parentId":e=parseInt(a.val(),10);break;case "lat":e=a.val();break;case "lng":e=a.val()}d[b]=e;this.model.set(d,{silent:true})},getDefaultModel:function(){return new Booki.CascadingItem({id:null,
value:"",cost:0,lat:0,lng:0,listId:this.cascadingList.get("id"),parentId:null})}})})(window.ajaxurl,window.jQuery,window.moment,window.accounting);
(function(k,f,g,c){Booki.CascadingListView=Booki.ViewBase.extend({events:{"click .update.btn":"save","click .delete.btn":"delete","change input":"inputChanged","change select":"selectedListChanged"},initialize:function(a){var b=f("#cascadinglist-template");this.projectId=a.projectId;this.selectedListId=null;_.bindAll(this,"render");if(b.length>0)this.template=_.template(b.html());this.currencySymbol=Booki.localization.currencySymbol;this.thousandsSep=Booki.localization.thousandsSep;this.decimalPoint=
Booki.localization.decimalPoint;this.render()},render:function(){var a=this,b;this.models&&this.models.reset();this.models=new Booki.CascadingLists({projectId:this.projectId});this.models.fetch({reset:true,success:function(e){(b=typeof a.selectedListId!=="number"?e.find(function(d){return d.get("id")===a.selectedListId}):e.at(0))||(b=a.getDefaultModel());a.selectedListId=null;a.renderLists(b,e)}})},renderLists:function(a){var b;this.model=a;if(this.el){b=f(this.el);a=this.template({context:this,isNew:a.isNew(),
model:a.toJSON(),models:this.models.toJSON(),localization:Booki.localization,accounting:c});b.html(a);this.createCascadingItemView();this.validate();this.tooltip()}},createNew:function(){this.selectedListId=null;this.renderLists(this.getDefaultModel())},selectedListChanged:function(a){var b=parseInt(f("option:selected",a.srcElement||a.target).val(),10);if(b===-1)this.createNew();else if(a=this.models.find(function(e){return e.get("id")===b})){this.selectedListId=b;this.renderLists(a)}},"delete":function(){var a=
this.model,b=this;this.selectedListId=null;a.destroy({success:function(){b.render()}})},save:function(){var a=this.model,b=this;this.selectedListId=this.model.get("id");this.isValid()&&a.save(a.attributes,{success:function(){b.render()}})},inputChanged:function(a){var b=a.srcElement||a.target;a=f(b);b=b.name;var e,d={};switch(b){case "label":e=a.val();break;case "isRequired":e=a.is(":checked")}d[b]=e;this.model.set(d,{silent:true})},createCascadingItemView:function(){if(this.cascadingItemView){this.cascadingItemView.undelegateEvents();
delete this.cascadingItemView}this.cascadingItemView=new Booki.CascadingItemView({cascadingList:this.model,cascadingLists:this.models,el:f("#cascadingitem-view")})},getDefaultModel:function(){return new Booki.CascadingList({id:null,projectId:this.projectId,label:"",isRequired:false,cascadingItems:new Booki.CascadingItems})},dispose:function(){this.cascadingItemView&&this.cascadingItemView.undelegateEvents()}})})(window.ajaxurl,window.jQuery,window.moment,window.accounting);
(function(k,f){Booki.FormElementsView=Booki.ViewBase.extend({events:{"click .edit.btn":"editFormElement","click .delete.btn":"deleteFormElement","click .save.btn":"savePendingModels","click #deleteFormElementModal .delete-form-element":"permanentlyDeleteFormElement"},initialize:function(g){var c=f("#formelements-template");this.projectId=g.projectId;this.rows=this.cols=0;_.bindAll(this,"render");this.createCollection();if(c.length>0)this.template=_.template(c.html());this.render()},render:function(){var g=
this;this.collection.fetch({success:function(c,a){g.collection.reset(a.formElements);g.cols=parseInt(a.cols,10);g.rows=parseInt(a.rows,10);g.el&&g.renderCollection();return g}});return this},addPendingModels:function(g){var c;if(!this.pendingModels)this.pendingModels=new Backbone.Collection;for(c in g)this.pendingModels.add(g[c])},savePendingModels:function(){var g,c=this;if(this.pendingModels.length>0){g=this.pendingModels.pop();g.save(g.attributes,{success:function(){c.pendingModels.length>0?c.savePendingModels():
c.renderCollection()}})}},renderCollection:function(){if(this.el){var g=this.template({context:this,models:this.collection.models,isDirty:this.pendingModels&&this.pendingModels.length>0});f(this.el).html(g);this.createModelView();this.createSidenavView()}},createCollection:function(){this.collection&&this.collection.reset();this.collection=new Booki.FormElements(new Backbone.Model({id:this.projectId}))},resetCollection:function(){this.createCollection();this.render()},getModelById:function(g){return this.collection.find(function(c){return c.get("id")===
g})},createSidenavView:function(){var g={count:this.collection.length};if(this.sidenavView)this.sidenavView.model.set(g);else this.sidenavView=new Booki.SidenavView({template:f("#formelement-sidenav-template"),tab:".formbuilder-tab",el:f("#formelement-sidenav-view"),model:new Backbone.Model(g)})},createModelView:function(g){var c=this;if(this.modelView)g&&this.modelView.model.set(g.attributes);else this.modelView=new Booki.FormElementView({projectId:this.projectId,model:g,cols:this.cols,rows:this.rows,
el:f("#formelement-view"),onSaved:function(){c.resetCollection()}})},editFormElement:function(g){g=f(g.currentTarget);this.createModelView(this.getModelById(parseInt(g.val(),10)));this.sidenavView.showTab(0)},deleteFormElement:function(g){g=f(g.currentTarget);this.modelForDelete=this.getModelById(parseInt(g.val(),10))},permanentlyDeleteFormElement:function(){var g=this;if(!this.body)this.body=f("body");this.body.removeClass("modal-open");f(".modal-backdrop").remove();this.modelForDelete&&this.modelForDelete.destroy({success:function(){g.renderCollection();
g.sidenavView.showTab(1)}})},dispose:function(){if(this.sidenavView){this.sidenavView.undelegateEvents();this.sidenavView.dispose()}this.modelView&&this.modelView.undelegateEvents()}})})(window.ajaxurl,window.jQuery);
(function(k,f,g){Booki.FormElementView=Booki.ViewBase.extend({events:{"change input":"formElementChanged","change select":"formElementChanged",'keyup input[name="dataItem"]':"testDatasourceToolbar","click .btn-group.datasource .add":"addDatasourceItem","click .btn-group.datasource .remove":"removeDatasourceItem","click .btn-group.datasource .select":"selectDatasourceItem","click .btn-group.main .add":"saveModel","click .btn-group.main .update":"saveModel","click .btn-group.main .createnew":"createNew"},
initialize:function(c){var a=f("#formelement-template"),b=c.cols,e=c.rows;this.projectId=c.projectId;this.onSaved=c.onSaved;this.cols=[];this.rows=[];for(c=1;c<=b;c++)this.cols.push(c);for(c=1;c<=e;c++)this.rows.push(c);if(!this.model)this.model=this.getDefaultModel();g.bindAll(this,"render");this.model.bind("change",this.render);if(a.length>0)this.template=g.template(a.html());this.render()},render:function(c){var a,b,e,d;c=c||this.model;if(this.el){a=f(this.el);d=this.model.get("elementType");b=
parseInt(a.find('select[name="colIndex"] option:selected').val(),10);e=parseInt(a.find('select[name="rowIndex"] option:selected').val(),10);c=this.template({elementTypes:["Textbox","TextArea","Dropdown List","Listbox","Checkbox","RadioButton","H1","H2","H3","H4","H5","H6","PlainText","Terms and Conditions"],context:this,isNew:c.isNew(),model:c.toJSON(),cols:this.cols.sort(this.sortIntAsc),rows:this.rows.sort(this.sortIntAsc),colIndexShow:c.get("colIndex")!==b,rowIndexShow:c.get("rowIndex")!==e,parseDefault:this.parseDefault,
toBool:this.toBool,supportsValueAttribute:[0,1,2,3,4,5,13].indexOf(d)!==-1});a.html(c);this.initDataBindingControls();this.testDatasourceToolbar();this.validate({validators:{minoptions:function(){return{validate:function(h,i,j){return j.$element["0"].options.length>i-1},priority:2}},selectone:function(){return{validate:function(h,i){if(!i)return true;return!(h==="-1"&&!a.find('input[name="'+i+'"]').val())},priority:2}}},messages:{minoptions:"Datasource cannot be empty.",selectone:"Tag required. Select an existing tag or enter a new one."}})}this.$(".btn-group.main .update.btn").prop("disabled",
this.model.isNew());this.$(".btn-group.main .createnew.btn").prop("disabled",this.model.isNew());this.$(".btn-group.main .add.btn").prop("disabled",!this.model.isNew());this.tooltip()},toBool:function(c){if(typeof c==="boolean")return c;return parseInt(this.parseDefault(c,0),10)!==0},addDatasourceItem:function(){var c=f(this._dataItem),a=f(this._bindingData),b=c.val();if(b.trim().length>0){a.append('<option value="'+a[0].options.length+'">'+b+"</option>");c.val("");c=a[0].options;f(c[c.length-1]).attr("selected",
"selected");a.focus()}},removeDatasourceItem:function(){var c=this._bindingData;c=f(c.options[c.selectedIndex]);var a=this.model.get("value"),b=c.text();if(a===b){f(this._value).val("");this.model.set({value:""},{silent:true})}c.remove();this.testDatasourceToolbar()},selectDatasourceItem:function(){var c=this._bindingData;c=f(c.options[c.selectedIndex]).text();f(this._value).val(c);this.model.set({value:c},{silent:true});this.testDatasourceToolbar()},formElementChanged:function(c){var a=c.srcElement||
c.target;c=f(a);var b=a.name;a=a.type;var e,d={},h=true,i,j=c.hasClass("validation"),l=this.model.get("validation");switch(b){case "label":e=c.val();break;case "colIndex":case "rowIndex":e=this.parseSelectValue(a,c,b);if(e===-1)return;break;case "bindingData":this.testDatasourceToolbar();return;case "value":e=a==="checkbox"?c.is(":checked"):c.val();break;case "defaultselection":e=[c.is(":checked")];b="bindingData";break;case "className":e=c.val();break;case "lineSeparator":e=c.is(":checked");break;
case "once":e=c.is(":checked");break;case "capability":e=parseInt(c.val(),10);break;case "elementType":e=parseInt(c.val(),10);this.model.set({colIndex:0,rowIndex:0},{silent:true});h=false;break;case "entrytype":i=c.find(":selected").val();e=this.cloneObject(l,i,true);f(["digits","number","alphanum"]).each(function(n,m){if(m!==i)e[m]=null});b="validation";break;default:if(j){j=c.is(":checked");if(b==="email"){h=false;j||(d.capability=0)}e=this.cloneObject(l,b,a==="checkbox"?j:c.val());b="validation"}}d[b]=
e;this.model.set(d,{silent:h})},cloneObject:function(c,a,b){var e,d={};for(e in c)if(c.hasOwnProperty(e))d[e]=a===e?b:c[e];return d},parseSelectValue:function(c,a,b){var e=f(this.el).find(".form-group.new"+b);if(c==="select-one"){c=a.find("option:selected").val();if(c!=="-1")e.addClass("hide");else{e.removeClass("hide");c=a.val()}}else{f(this.el).find('select[name="'+b+'"]').parsley("destroy");c=a.val()}return parseInt(c,10)},testDatasourceToolbar:function(){if(this._bindingData){var c=f(this.el),
a=this._bindingData,b=a.selectedIndex,e=f(a.options[b]).text(),d=c.find(".btn-group.datasource .add"),h=c.find(".btn-group.datasource .remove");c=c.find(".btn-group.datasource .select");a=a.options.length===0||b===-1;d.prop("disabled",f(this._dataItem).val().length===0);h.prop("disabled",a);c.prop("disabled",a||f(this._value).val()===e)}},initDataBindingControls:function(){var c=f(this.el);this._bindingData=c.find('select[name="bindingData"]')[0];this._value=c.find('input[name="value"]')[0];this._dataItem=
c.find('input[name="dataItem"]')[0]},saveModel:function(){var c=this,a=this.model,b=a.isNew(),e,d=this.onSaved,h=a.get("validation"),i=a.get("colIndex"),j=a.get("rowIndex");this.initDataBindingControls();if(this._bindingData){e=f(this._bindingData.options).map(function(){return f(this).text()}).get();a.set({bindingData:e},{silent:true})}if(this.isValid()){g.contains(this.cols,i)||this.cols.push(i);g.contains(this.rows,j)||this.rows.push(j);if(!this.toBool(h.digits)&&!this.toBool(h.number)){h.max=
0;h.min=0}if(this.toBool(h.digits)||this.toBool(h.number)){h.maxLength=0;h.minLength=0}a.set({validation:h},{silent:true});a.save(a.attributes,{success:function(l){c.model=l;b&&c.resetModel();d&&d(l)}})}},createNew:function(){this.resetModel()},getDefaultModel:function(){return new Booki.FormElement({id:null,projectId:this.projectId,label:"",elementType:Booki.ElementType.textbox,lineSeparator:false,rowIndex:0,colIndex:0,className:"",value:"",bindingData:[],once:false,capability:0,validation:{required:null,
notBlank:null,minLength:null,maxLength:null,min:null,max:null,regex:null,email:null,url:null,digits:null,number:null,alphanum:null,dateIso:null}})},resetModel:function(){this.model=this.getDefaultModel();this.model.bind("change",this.render);this.render()}})})(window.ajaxurl,window.jQuery,window._);
(function(k,f,g,c){Booki.OptionalsView=Booki.ViewBase.extend({events:{"click .update.btn":"save","click .delete.btn":"delete","click .createnew.btn":"createNew","click .add.btn":"save","change input":"inputChanged","change select":"listboxChanged"},initialize:function(a){var b=f("#optionals-template");this.projectId=a.projectId;_.bindAll(this,"render");if(b.length>0)this.template=_.template(b.html());this.currencySymbol=Booki.localization.currencySymbol;this.thousandsSep=Booki.localization.thousandsSep;
this.decimalPoint=Booki.localization.decimalPoint;this.render()},render:function(){var a=this,b=this.selectedId,e;(new Booki.Optionals({projectId:this.projectId})).fetch({success:function(d){(e=d.find(function(h){return h.get("id")===b}))||(e=a.getDefaultModel());a.renderOptionals(e,d)}})},renderOptionals:function(a,b){var e,d;this.model=a;this.models=b||new Booki.Optionals;this.models.bind("remove",this.render);a&&a.bind("change",this.render);if(this.el){e=f(this.el);d=this.template({context:this,
isNew:a.isNew(),model:a.toJSON(),models:b.models,localization:Booki.localization,accounting:c});e.html(d);this.$(".createnew.btn").prop("disabled",a.isNew());this.$(".update.btn").prop("disabled",a.isNew());this.$(".delete.btn").prop("disabled",a.isNew());this.$(".add.btn").prop("disabled",!a.isNew());this.validate();this.tooltip()}},createNew:function(){this.selectedId=null;this.renderOptionals(this.getDefaultModel(),this.models)},listboxChanged:function(a){var b=this.models,e=parseInt(f("option:selected",
a.srcElement||a.target).val(),10);(a=b.find(function(d){return d.get("id")===e}))&&this.renderOptionals(a,b)},"delete":function(){this.model.destroy({success:function(){}})},save:function(){var a=this.model;this.isValid()&&a.save(a.attributes,{success:function(){}})},inputChanged:function(a){var b=a.srcElement||a.target;a=f(b);b=b.name;var e,d={};switch(b){case "name":e=a.val();break;case "cost":e=a.val()}d[b]=e;this.model.set(d,{silent:true})},getDefaultModel:function(){return new Booki.Optional({id:null,
projectId:this.projectId,name:"",cost:""})}})})(window.ajaxurl,window.jQuery,window.moment,window.accounting);
(function(k,f){Booki.ProjectsView=Booki.ViewBase.extend({events:{"change select[name]":"projectSelectionChanged"},initialize:function(){var g=f("#projects-template");this.selectedId=-1;_.bindAll(this,"render");if(!this.collection)this.collection=new Booki.Projects;if(g.length>0)this.template=_.template(g.html());this.tags=new Backbone.Collection;this.hasFullControl=true;this.render()},render:function(){var g=this,c=this.collection;this.el&&c.fetch({success:function(a,b){g.collection.reset(b.projects);
g.tags.reset(b.tags);g.hasFullControl=b.hasFullControl;g.output(g.collection);if(g.selectedId===-1){g.tabs();g.createProjectView()}else g.tabs("enable")}});return this},output:function(g){var c=f(this.el);g=this.template({selectedId:this.selectedId,models:g.models,hasFullControl:this.hasFullControl});c.html(g);return this},createProjectView:function(g){var c=this;this.projectView&&this.projectView.undelegateEvents();this.projectView=new Booki.ProjectView({el:f("#project-view"),model:g,tags:this.tags,
hasFullControl:this.hasFullControl,onDeleted:function(a){c.selectedId=-1;c.collection.remove(a);c.render();c.createProjectView()},onCreated:function(a){var b=c.getModel(a.get("id"));b&&c.collection.remove(b,{silent:true});c.selectedId=a.get("id");c.collection.add(a);c.render()}})},projectSelectionChanged:function(g){g=f(g.currentTarget).val();g=parseInt(g,10);var c=this.getModel(g);this.tabs(g!==-1?"enable":"");this.selectedId=g;this.createProjectView(c)},tabs:function(g){var c=f('.booki .wizard-tab li:not(li a[href="#step1"])');
g==="enable"?c.removeClass("disabled"):c.addClass("disabled")},getModel:function(g){return this.collection.find(function(c){return c.get("id")===parseInt(g,10)})}})})(window.ajaxurl,window.jQuery);
(function(k,f,g){Booki.ProjectView=Booki.ViewBase.extend({events:{'change input[name], textarea[name], select[name="calendarMode"], select[name="defaultStep"], select[name="bookingMode"], select[name="tag"], select[name="bookingWizardMode"]':"projectChanged","click .duplicateProject":"duplicate","click .delete":"delete","click .update":"update","click .preview-thumbnail button":"thumbnailCloseClick"},initialize:function(c){var a=f("#project-template");g.bindAll(this,"render");this.onDeleted=c.onDeleted;
this.onCreated=c.onCreated;this.tags=c.tags;this.hasFullControl=c.hasFullControl;if(!this.model)this.model=this.getDefaultModel();this.model.bind("change",this.render);if(a.length>0)this.template=g.template(a.html());this.render()},render:function(){var c=f(this.el),a=this.model,b=a.isNew();if(this.el){c=f(this.el);a=this.template({isNew:b,model:a.toJSON(),tags:this.tags.models,hasFullControl:this.hasFullControl});c.html(a);this.tooltip();this.$imagePickerDialog=f("#imageGalleryModal .modal-body");
this.$image=c.find("div.preview-thumbnail");this.$imageDefault=c.find("div.preview-thumbnail-default");this.attachImageGalleryHandlers();this.validate({validators:{selectone:function(){return{validate:function(e,d){if(!d)return true;return!(e==="-1"&&!c.find('input[name="'+d+'"]').val())},priority:2}}},messages:{selectone:"Tag required. Select an existing tag or enter a new one."}})}return this},projectChanged:function(c){var a=c.srcElement||c.target;c=f(a);var b=a.name;a=a.type;var e=c.val(),d={},
h=["calendarMode","bookingMode","defaultStep","bookingWizardMode"],i=f(this.el).find(".form-group.newtag"),j=true;if(a==="checkbox"){e=c.is(":checked");if(b==="enableMonthSelection"){j=false;e||(d.monthsCount=1)}}else if(f.inArray(b,h)>-1){e=parseInt(c.find("option:selected").val(),10);if(b==="calendarMode"){j=false;d.enableMonthSelection=false;d.monthsCount=1}}else if(b==="tag"&&a==="select-one"){e=c.find("option:selected").val();if(e!=="-1")i.addClass("hide");else{i.removeClass("hide");e=c.val()}}else if(b===
"tag")f(this.el).find('select[name="tag"]').parsley("destroy");else if(b==="optionalsListingMode"){e=parseInt(c.val(),10);if(e===1)d.optionalsMinimumSelection=0;j=false}else if(b==="optionalsBookingMode"||b==="optionalsMinimumSelection")e=parseInt(c.val(),10);d[b]=e;if(!j&&this.model.isNew())d.tag="";this.model.set(d,{silent:j})},duplicate:function(){var c=this,a=this.model.get("duplicateProjectName"),b=this.model.get("id"),e=new Booki.DuplicateProject({projectId:b,projectName:a}),d;if(f.trim(a).length!==
0)if(this.isValid()){d=e.attributes;d.projectName=a;d.projectId=b;e.save(d,{success:function(h){c.model.set({id:h.id,name:a});c.onCreated&&c.onCreated(c.model);window.console.log(c.model)}})}},update:function(){this.save()},save:function(){var c=this,a=this.model,b=a.get("tag"),e=this.tags.find(function(d){return d.get("name")===b});if(this.isValid()){!e&&b&&this.tags.add(new Backbone.Model({name:b}));a.save(a.attributes,{success:function(d){c.onCreated&&c.onCreated(d)}})}},"delete":function(){var c=
this;this.model&&this.model.destroy({success:function(a){c.onDeleted&&c.onDeleted(a)}})},thumbnailCloseClick:function(c){c.preventDefault();this.updateThumbnail("");return false},updateThumbnail:function(c){this.model.set({previewUrl:c},{silent:true});if(c){this.$imageDefault.addClass("hide");this.$image.css("background-image",'url("'+c+'")');this.$image.removeClass("hide")}else{this.$image.addClass("hide");this.$imageDefault.removeClass("hide")}},imageGalleryPagerClick:function(c){var a=c.target.href,
b=this;if(a.length!==0){c.preventDefault();this.detachImageGalleryHandlers();c=k+a.substr(a.indexOf("?"));f.post(c,{action:"mediaLibraryPaging"},function(e){b.$imagePickerDialog.html(e);b.attachImageGalleryHandlers()})}},attachImageGalleryHandlers:function(){f("a.booki-first-page, a.booki-prev-page, a.booki-next-page, a.booki-last-page").on("click",f.proxy(this.imageGalleryPagerClick,this));f("a.image-item-selected").on("click",f.proxy(this.imagePickerSelectionChanged,this));f(".pager-indicator-textbox").attr("readonly",
true)},detachImageGalleryHandlers:function(){f("a.first-page, a.prev-page, a.next-page, a.last-page").off();f("a.image-item-selected").off()},imagePickerSelectionChanged:function(c){var a=c.currentTarget.href;c.preventDefault();if(a.length!==0){c=a.substr(a.indexOf("#")+1);c.length>0&&this.updateThumbnail(c)}},getDefaultModel:function(){return new Booki.Project({id:null,status:Booki.ProjectStatus.running,name:"",duplicateProjectName:"",bookingDaysMinimum:0,bookingDaysLimit:1,calendarMode:Booki.CalendarMode.popup,
bookingMode:Booki.BookingMode.reservation,description:"",previewUrl:"",tag:"",notifyUserEmailList:"",optionalsBookingMode:0,optionalsListingMode:0,optionalsMinimumSelection:0,defaultStep:Booki.ProjectStep.bookingForm,bookingTabLabel:Booki.resx.PROJECT_TAB_BOOKING_TAB_LABEL_DEFAULT,customFormTabLabel:Booki.resx.PROJECT_TAB_CUSTOM_FORM_TAB_LABEL_DEFAULT,attendeeTabLabel:Booki.resx.PROJECT_TAB_ATTENDEE_TAB_LABEL_DEFAULT,availableDaysLabel:Booki.resx.PROJECT_TAB_AVAILABLE_DAYS_LABEL_DEFAULT,selectedDaysLabel:Booki.resx.PROJECT_TAB_SELECTED_DAYS_LABEL_DEFAULT,
bookingTimeLabel:Booki.resx.PROJECT_TAB_BOOKING_TIME_LABEL_DEFAULT,optionalItemsLabel:Booki.resx.PROJECT_TAB_OPTIONAL_ITEM_LABEL_DEFAULT,nextLabel:Booki.resx.PROJECT_TAB_NEXT_LABEL_DEFAULT,prevLabel:Booki.resx.PROJECT_TAB_PREV_LABEL_DEFAULT,addToCartLabel:Booki.resx.PROJECT_TAB_ADD_TO_CART_LABEL_DEFAULT,fromLabel:Booki.resx.PROJECT_TAB_FROM_LABEL_DEFAULT,toLabel:Booki.resx.PROJECT_TAB_TO_LABEL_DEFAULT,proceedToLoginLabel:Booki.resx.PROJECT_TAB_PROCEED_TO_LOGIN_LABEL_DEFAULT,makeBookingLabel:Booki.resx.PROJECT_TAB_MAKE_BOOKING_LABEL_DEFAULT,
bookingLimitLabel:Booki.resx.PROJECT_TAB_BOOKING_LIMIT_LABEL_DEFAULT,contentTop:"",contentBottom:"",bookingWizardMode:Booki.BookingWizardMode.tabs,hideSelectedDays:false,displayAttendees:false,banList:"",defaultDateSelected:true})}})})(window.ajaxurl,window.jQuery,window._);
(function(k,f){Booki.SidenavView=Booki.ViewBase.extend({initialize:function(g){var c=g.template;this.disableHyperLinkDelegate=function(a){a.preventDefault();return false};_.bindAll(this,"render");this.model&&this.model.bind("change",this.render);if(c.length>0)this.template=_.template(c.html());this.render();this.tabId=g.tab},render:function(){var g;if(this.el){g=this.template({model:this.model});f(this.el).html(g)}return this},showTab:function(g){var c=f(this.tabId).find("a");f(c[g]).tab("show")},
disableTab:function(g,c){var a=f(this.tabId).find("a");a=f(a[g]);var b=this.disableHyperLinkDelegate;if(c){a.bind("click",b);a.parent().addClass("disabled");a.removeAttr("data-toggle");a.css("cursor","not-allowed")}else{a.unbind("click",b);a.parent().removeClass("disabled");a.attr("data-toggle","tab");a.css("cursor","")}},dispose:function(){var g=f(this.tabId),c=this.disableHyperLinkDelegate;if(g&&this.el){g=g.find("a");f.each(g,function(a,b){f(b).unbind("click",c)});f(g[0]).tab("show")}}})})(window.ajaxurl,
window.jQuery);
